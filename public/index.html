<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#e5e7eb}
.hidden{display:none}
button{cursor:pointer}
.sidebar{width:300px;background:#020617;height:100vh;overflow:auto}
.chat{flex:1;display:flex;flex-direction:column}
.container{display:flex;height:100vh}
.list-item{padding:10px;border-bottom:1px solid #1e293b;display:flex;align-items:center;gap:10px;cursor:pointer}
.list-item:hover{background:#020617}
.msg{margin:5px;padding:10px;border-radius:10px;max-width:70%}
.sent{background:#2563eb;align-self:flex-end}
.received{background:#1e293b}
#messages{flex:1;overflow:auto;padding:10px}
input,textarea{width:100%;padding:10px;background:#020617;color:white;border:none}
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth-box">
  <h2>Login</h2>
  <input id="login-user" placeholder="Username or Email">
  <input id="login-pass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="auth-error"></p>
</div>

<!-- APP -->
<div id="app-box" class="hidden">
  <div class="container">

    <!-- SIDEBAR -->
    <div class="sidebar">
      <button onclick="loadFriends()">Friends</button>
      <button onclick="loadChats()">Chats</button>
      <button onclick="logout()">Logout</button>
      <div id="list"></div>
    </div>

    <!-- CHAT -->
    <div class="chat">
      <div id="messages"></div>
      <textarea id="msg" placeholder="Type message"></textarea>
      <button onclick="sendMessage()">Send</button>
    </div>

  </div>
</div>

<script>
const API = "/api";
let token = localStorage.getItem("token");
let currentUser = JSON.parse(localStorage.getItem("user"));
let socket = null;
let currentChatId = null;

// ================= AUTH =================
async function login(){
  const username = login-user.value;
  const password = login-pass.value;

  const res = await fetch(API + "/login",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ username, password })
  });

  const data = await res.json();
  if(!res.ok){
    auth-error.textContent = data.error;
    return;
  }

  token = data.token;
  currentUser = data.user;
  localStorage.setItem("token",token);
  localStorage.setItem("user",JSON.stringify(data.user));
  initApp();
}

// ================= INIT =================
function initApp(){
  auth-box.classList.add("hidden");
  app-box.classList.remove("hidden");

  socket = io({
    auth:{ token }
  });

  socket.on("new_message",data=>{
    if(data.chatId === currentChatId){
      appendMessage(data.message,false);
    }
  });

  socket.on("typing",()=>{});
  socket.on("typing_stopped",()=>{});

  loadFriends();
}

if(token && currentUser) initApp();

// ================= FRIENDS =================
async function loadFriends(){
  const res = await fetch(API+"/friends",{
    headers:{ Authorization:`Bearer ${token}` }
  });
  const friends = await res.json();
  renderList(friends,"friend");
}

// ================= CHATS =================
async function loadChats(){
  const res = await fetch(API+"/chats",{
    headers:{ Authorization:`Bearer ${token}` }
  });
  const chats = await res.json();
  renderList(chats,"chat");
}

// ================= RENDER =================
function renderList(data,type){
  list.innerHTML="";
  data.forEach(item=>{
    const div=document.createElement("div");
    div.className="list-item";

    let user = type==="chat" ? item.otherParticipant : item;
    div.textContent = user.name || user.username;

    div.onclick=()=>{
      openChat(user,item._id);
    };
    list.appendChild(div);
  });
}

// ================= CHAT =================
async function openChat(user,chatId){
  currentChatId = chatId;
  messages.innerHTML="";
}

async function sendMessage(){
  if(!currentChatId) return;
  const text = msg.value.trim();
  if(!text) return;

  msg.value="";

  const temp = {
    _id:Date.now(),
    text,
    sender:{ _id:currentUser._id },
    createdAt:new Date()
  };
  appendMessage(temp,true);

  const res = await fetch(API+"/messages",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:`Bearer ${token}`
    },
    body:JSON.stringify({ chatId:currentChatId,text })
  });
}

// ================= UI =================
function appendMessage(msg,isMe){
  const div=document.createElement("div");
  div.className="msg "+(isMe?"sent":"received");
  div.textContent=msg.text;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}

// ================= LOGOUT =================
function logout(){
  localStorage.clear();
  location.reload();
}
</script>

</body>
</html>
