<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learnox Pro V2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; 
        }

        /* --- AUTH --- */
        .auth-card { 
            background: white; padding: 2.5rem; border-radius: 16px; width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); 
            animation: fadeUp 0.5s ease;
        }
        .form-input { 
            width: 100%; padding: 14px; margin-bottom: 12px; border: 2px solid #e1e5e9; 
            border-radius: 8px; background: #f8f9fa; outline: none; transition: 0.3s;
        }
        .form-input:focus { border-color: #667eea; background: white; }
        .btn-primary { 
            width: 100%; padding: 14px; background: linear-gradient(to right, #667eea, #764ba2); 
            color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; 
        }
        .hidden { display: none !important; }

        /* --- APP --- */
        .app-layout { 
            display: none; width: 95vw; height: 95vh; background: white; border-radius: 20px; 
            box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden; display: flex; 
        }
        
        /* Sidebar */
        .sidebar { width: 340px; border-right: 1px solid #eee; display: flex; flex-direction: column; background: #fcfcfc; }
        .profile-header { padding: 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar-sm { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #667eea; }
        .nav-tabs { display: flex; background: white; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #777; font-weight: 600; border-bottom: 3px solid transparent; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; background: #f4f6ff; }
        .list-area { flex: 1; overflow-y: auto; }
        .list-item { padding: 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
        .list-item:hover { background: #f9f9f9; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; border: 2px solid white; position: absolute; bottom: 0; right: 0; }
        .status-dot.online { background: #00d26a; }

        /* Chat Area */
        .chat-view { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; }
        .chat-header { padding: 15px 25px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; background: white; z-index: 10; }
        .chat-info h3 { font-size: 16px; margin: 0; }
        .typing-indicator { font-size: 12px; color: #667eea; font-weight: bold; display: none; }
        
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: #f4f5f7; }
        
        /* Message Bubbles */
        .msg { max-width: 70%; padding: 10px 14px; border-radius: 12px; font-size: 14px; position: relative; word-wrap: break-word; line-height: 1.4; cursor: pointer; }
        .msg.sent { align-self: flex-end; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: white; border: 1px solid #eee; color: #333; border-bottom-left-radius: 2px; }
        
        .msg-meta { display: flex; justify-content: flex-end; align-items: center; gap: 4px; font-size: 10px; margin-top: 4px; opacity: 0.8; }
        .ticks { font-size: 10px; }
        .ticks.seen { color: #00e5ff; } /* Blue Ticks for sent msg */
        
        .reactions-display { position: absolute; bottom: -10px; right: 10px; background: white; border-radius: 10px; padding: 2px 5px; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; }
        
        .input-box { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white; }
        .msg-input { flex: 1; padding: 12px 20px; border-radius: 25px; border: 2px solid #eee; outline: none; }
        .msg-input:focus { border-color: #667eea; }

        /* Context Menu */
        .context-menu { position: absolute; background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: 150px; display: none; z-index: 100; overflow: hidden; }
        .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 13px; color: #333; display: flex; align-items: center; gap: 8px; }
        .ctx-item:hover { background: #f5f5f5; color: #667eea; }
        
        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 350px; text-align: center; }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="auth-card" id="auth-box">
        <h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">Learnox Pro</h2>
        <input type="text" id="reg-name" class="form-input hidden" placeholder="Full Name">
        <input type="text" id="reg-username" class="form-input hidden" placeholder="@Username">
        <input type="email" id="email" class="form-input" placeholder="Email">
        <input type="password" id="password" class="form-input" placeholder="Password">
        <button class="btn-primary" onclick="handleAuth()">Login</button>
        <p style="text-align: center; margin-top: 15px; font-size: 13px; color: #666; cursor: pointer;" onclick="toggleAuthMode()">New here? Create Account</p>
    </div>

    <div class="app-layout" id="app-box">
        <div class="sidebar">
            <div class="profile-header" onclick="openProfile()">
                <img id="my-avatar" class="avatar-sm" src="">
                <div>
                    <h4 id="my-name">User</h4>
                    <small id="my-username" style="color: #667eea;">@username</small>
                </div>
            </div>
            
            <div class="nav-tabs">
                <div class="tab active" onclick="switchTab('chats')">Chats</div>
                <div class="tab" onclick="switchTab('friends')">Friends</div>
                <div class="tab" onclick="switchTab('find')">Find</div>
            </div>

            <div class="list-area" id="list-container"></div>
        </div>

        <div class="chat-view" id="chat-ui" style="display: none;">
            <div class="chat-header">
                <img id="chat-img" class="avatar-sm" src="">
                <div class="chat-info" onclick="viewUserProfile()">
                    <h3 id="chat-name">Name</h3>
                    <div style="font-size: 12px; color: #888;" id="chat-status">Offline</div>
                    <div class="typing-indicator" id="typing-indicator">typing...</div>
                </div>
                <div style="margin-left: auto; display: flex; gap: 10px;">
                    <i class="fas fa-ban" title="Block" onclick="blockUser()" style="cursor:pointer; color:#999;"></i>
                </div>
            </div>

            <div class="messages-container" id="messages"></div>

            <div class="input-box">
                <input type="text" id="msg-input" class="msg-input" placeholder="Type a message..." oninput="handleTyping()" onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="btn-primary" style="width: 50px; border-radius: 50%;" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div class="chat-view" id="empty-state" style="justify-content: center; align-items: center; color: #ccc;">
            <i class="fas fa-comments" style="font-size: 60px; margin-bottom: 20px;"></i>
            <h3>Select a conversation</h3>
        </div>
    </div>

    <div class="context-menu" id="ctx-menu">
        <div class="ctx-item" onclick="reactToMessage('??')">?? Love</div>
        <div class="ctx-item" onclick="reactToMessage('??')">?? Haha</div>
        <div class="ctx-item" onclick="editSelectedMessage()"><i class="fas fa-edit"></i> Edit</div>
        <div class="ctx-item" onclick="deleteSelectedMessage()" style="color: red;"><i class="fas fa-trash"></i> Delete</div>
    </div>

    <div class="modal-overlay" id="profile-modal">
        <div class="modal">
            <h3>My Profile</h3>
            <img id="preview-avatar" src="" style="width:80px; height:80px; border-radius:50%; margin: 15px auto; display:block;">
            <input type="file" id="avatar-upload" style="margin-bottom:15px;">
            <input type="text" id="edit-name" class="form-input" placeholder="Name">
            <input type="password" id="new-pass" class="form-input" placeholder="New Password (Optional)">
            <button class="btn-primary" onclick="updateProfile()">Save</button>
            <button onclick="logout()" style="margin-top:10px; background:none; border:none; color:red; cursor:pointer;">Logout</button>
            <button onclick="closeModal('profile-modal')" style="position:absolute; top:10px; right:10px; border:none; background:none;">X</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="view-user-modal">
        <div class="modal">
            <h3 id="view-user-name">User</h3>
            <p id="view-user-username" style="color: #667eea; margin-bottom: 20px;">@user</p>
            <button class="btn-primary" onclick="closeModal('view-user-modal')">Close</button>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3000/api';
        let token, currentUser, socket, currentChatId;
        let isRegister = false;
        let selectedMsgId = null; // For context menu

        // --- AUTH ---
        function toggleAuthMode() {
            isRegister = !isRegister;
            document.getElementById('reg-name').classList.toggle('hidden');
            document.getElementById('reg-username').classList.toggle('hidden');
            document.querySelector('button').innerText = isRegister ? 'Register' : 'Login';
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('reg-name').value;
            const username = document.getElementById('reg-username').value;
            
            const endpoint = isRegister ? '/register' : '/login';
            const body = isRegister ? {name, username, email, password} : {email, password};

            try {
                const res = await fetch(API + endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if(data.error) return alert(data.error);
                
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                initApp();
            } catch(e) { alert('Connection failed'); }
        }

        // --- INIT ---
        function initApp() {
            token = localStorage.getItem('token');
            currentUser = JSON.parse(localStorage.getItem('user'));
            if(!token) return;

            document.getElementById('auth-box').style.display = 'none';
            document.getElementById('app-box').style.display = 'flex';
            
            document.getElementById('my-name').innerText = currentUser.name;
            document.getElementById('my-username').innerText = '@' + currentUser.username;
            document.getElementById('my-avatar').src = currentUser.avatar || 'https://via.placeholder.com/50';

            // Socket
            socket = io('http://localhost:3000');
            socket.emit('join_user', currentUser._id);
            
            socket.on('new_message', (msg) => {
                if(currentChatId === msg.chat) {
                    appendMessage(msg);
                    socket.emit('mark_seen', { chatId: currentChatId }); // Mark seen immediately if open
                } else {
                    notifyUser(msg); // Browser Notification
                }
                moveChatToTop(msg.chat); // Sort logic
            });

            socket.on('msg_status_update', ({ msgId, status }) => {
                const el = document.getElementById(`tick-${msgId}`);
                if(el) el.innerHTML = getTickIcon(status);
            });

            socket.on('typing', ({userId}) => {
                if(currentChatId) document.getElementById('typing-indicator').style.display = 'block';
            });
            socket.on('stop_typing', () => {
                document.getElementById('typing-indicator').style.display = 'none';
            });

            // Re-render
            socket.on('message_updated', (data) => {
                const el = document.querySelector(`#msg-${data.id} .text`);
                if(el) el.innerText = data.text + " (edited)";
            });

            socket.on('message_deleted', (data) => {
                const el = document.getElementById(`msg-${data.id}`);
                if(el) el.remove();
            });

            switchTab('chats');
            Notification.requestPermission();
        }

        // --- CORE CHAT LOGIC ---
        let typingTimeout;
        function handleTyping() {
            socket.emit('typing', { chatId: currentChatId });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => socket.emit('stop_typing', { chatId: currentChatId }), 1000);
        }

        async function openChat(chatId, user) {
            currentChatId = chatId;
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('chat-ui').style.display = 'flex';
            
            document.getElementById('chat-name').innerText = user.name;
            document.getElementById('chat-status').innerText = user.status;
            document.getElementById('chat-img').src = user.avatar || 'https://via.placeholder.com/50';
            
            socket.emit('join_chat', chatId);
            socket.emit('mark_seen', { chatId }); // Mark all as seen

            const res = await fetch(`${API}/chats/${chatId}/messages`, {headers: {'Authorization': `Bearer ${token}`}});
            const msgs = await res.json();
            const container = document.getElementById('messages');
            container.innerHTML = '';
            msgs.forEach(appendMessage);
            scrollToBottom();
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            // Optimistic UI (Render immediately)
            const tempId = Date.now();
            const tempMsg = { _id: tempId, text, sender: currentUser, status: 'sent', createdAt: new Date() };
            appendMessage(tempMsg);
            input.value = '';
            scrollToBottom();
            moveChatToTop(currentChatId);

            const res = await fetch(`${API}/messages`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                body: JSON.stringify({ chatId: currentChatId, text })
            });
            const realMsg = await res.json();
            
            // Replace Temp with Real ID for events
            const el = document.getElementById(`msg-${tempId}`);
            if(el) {
                el.id = `msg-${realMsg._id}`;
                el.setAttribute('oncontextmenu', `showCtxMenu(event, '${realMsg._id}', true)`);
            }
        }

        function appendMessage(msg) {
            const isMe = msg.sender._id === currentUser._id;
            const time = new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            div.id = `msg-${msg._id}`;
            div.innerHTML = `
                <div class="text">${msg.text} ${msg.edited ? '<small>(edited)</small>' : ''}</div>
                <div class="msg-meta">
                    <span>${time}</span>
                    ${isMe ? `<span id="tick-${msg._id}" class="ticks">${getTickIcon(msg.status)}</span>` : ''}
                </div>
                ${msg.reactions && Object.keys(msg.reactions).length > 0 ? `<div class="reactions-display">??</div>` : ''}
            `;
            
            // Context Menu Event
            div.oncontextmenu = (e) => showCtxMenu(e, msg._id, isMe);
            // Mobile long press support could be added here
            
            document.getElementById('messages').appendChild(div);
        }

        function getTickIcon(status) {
            if(status === 'sent') return '<i class="fas fa-check"></i>';
            if(status === 'delivered') return '<i class="fas fa-check-double"></i>';
            if(status === 'seen') return '<i class="fas fa-check-double" style="color: #00e5ff;"></i>'; // Blue ticks
            return '';
        }

        // --- SORTING & LISTS ---
        async function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const container = document.getElementById('list-container');
            container.innerHTML = 'Loading...';

            let endpoint = tab === 'chats' ? '/chats' : (tab === 'friends' ? '/friends' : '/users/search');
            if(tab === 'find') {
                container.innerHTML = '<input type="text" placeholder="Search @username..." onkeyup="searchUsers(this.value)" style="width:100%; padding:10px; margin:10px; border:1px solid #ddd;"> <div id="search-results"></div>';
                return;
            }

            const res = await fetch(API + endpoint, {headers: {'Authorization': `Bearer ${token}`}});
            const data = await res.json();
            renderList(data, tab);
        }

        function renderList(data, type) {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            
            data.forEach(item => {
                const el = document.createElement('div');
                el.className = 'list-item';
                
                // For Chats, get other participant
                let user, subtext, id;
                if(type === 'chats') {
                    user = item.participants.find(p => p._id !== currentUser._id);
                    subtext = item.lastMessage ? item.lastMessage.text : 'No messages';
                    id = item._id; // Chat ID
                    el.id = `chat-item-${id}`;
                } else {
                    user = item;
                    subtext = '@' + user.username;
                    id = null;
                }

                el.innerHTML = `
                    <div style="position:relative;">
                        <img src="${user.avatar || 'https://via.placeholder.com/50'}" style="width:40px; height:40px; border-radius:50%;">
                        <div class="status-dot ${user.status === 'online' ? 'online' : ''}"></div>
                    </div>
                    <div>
                        <h4 style="font-size:14px; margin:0;">${user.name}</h4>
                        <p style="font-size:12px; color:#888; margin:0;">${subtext}</p>
                    </div>
                `;
                
                el.onclick = () => {
                    if(type === 'chats') openChat(id, user);
                    else if(type === 'friends') createChat(user._id);
                };
                container.appendChild(el);
            });
        }

        async function createChat(userId) {
            const res = await fetch(`${API}/chats`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                body: JSON.stringify({ userId })
            });
            const chat = await res.json();
            openChat(chat._id, chat.participants.find(p => p._id !== currentUser._id));
            switchTab('chats');
        }

        function moveChatToTop(chatId) {
            const el = document.getElementById(`chat-item-${chatId}`);
            if(el) {
                const parent = el.parentNode;
                parent.prepend(el);
                el.style.background = '#f0f7ff'; // Highlight briefly
                setTimeout(() => el.style.background = 'transparent', 1000);
            }
        }

        async function searchUsers(q) {
            if(q.length < 2) return;
            const res = await fetch(`${API}/users/search?q=${q}`, {headers: {'Authorization': `Bearer ${token}`}});
            const users = await res.json();
            const resDiv = document.getElementById('search-results');
            resDiv.innerHTML = '';
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<img src="${u.avatar}" style="width:30px; height:30px; border-radius:50%;"> ${u.username} <button onclick="sendRequest('${u._id}')" style="margin-left:auto; cursor:pointer;">Add</button>`;
                resDiv.appendChild(div);
            });
        }

        async function sendRequest(id) {
            await fetch(`${API}/friend-requests/send`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                body: JSON.stringify({receiverId: id})
            });
            alert('Sent!');
        }

        // --- CONTEXT MENU (Edit/Delete) ---
        function showCtxMenu(e, msgId, isMe) {
            e.preventDefault();
            selectedMsgId = msgId;
            const menu = document.getElementById('ctx-menu');
            menu.style.display = 'block';
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;
            
            // Hide Edit/Delete if not my message
            const items = menu.children;
            items[2].style.display = isMe ? 'flex' : 'none';
            items[3].style.display = isMe ? 'flex' : 'none';
            
            // Hide on click elsewhere
            document.addEventListener('click', () => menu.style.display = 'none', {once: true});
        }

        async function editSelectedMessage() {
            const newText = prompt("Edit Message:");
            if(newText) {
                await fetch(`${API}/messages/${selectedMsgId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                    body: JSON.stringify({text: newText})
                });
            }
        }

        async function deleteSelectedMessage() {
            if(confirm("Delete message?")) {
                await fetch(`${API}/messages/${selectedMsgId}`, {
                    method: 'DELETE',
                    headers: {'Authorization': `Bearer ${token}`}
                });
            }
        }

        async function reactToMessage(emoji) {
            await fetch(`${API}/messages/${selectedMsgId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                body: JSON.stringify({reaction: emoji})
            });
        }

        // --- UTILS ---
        function scrollToBottom() {
            const c = document.getElementById('messages');
            c.scrollTop = c.scrollHeight;
        }

        function notifyUser(msg) {
            if(document.hidden && Notification.permission === "granted") {
                new Notification(`New message from ${msg.sender.name}`, { body: msg.text });
            }
        }

        function logout() { localStorage.clear(); location.reload(); }
        function openProfile() { document.getElementById('profile-modal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Initialize
        if(localStorage.getItem('token')) initApp();
    </script>
</body>
</html>