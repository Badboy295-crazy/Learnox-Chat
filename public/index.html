<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learnox - Secure Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --primary: #667eea; --secondary: #764ba2; --bg: #f0f2f5; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, var(--primary), var(--secondary)); height: 100vh; display: flex; align-items: center; justify-content: center; }
        
        .app-container { width: 95vw; height: 90vh; background: white; border-radius: 15px; display: flex; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        /* Sidebar */
        .sidebar { width: 350px; border-right: 1px solid #ddd; display: flex; flex-direction: column; background: #fff; }
        .side-header { padding: 15px; background: #f0f2f5; display: flex; justify-content: space-between; align-items: center; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        
        .search-box { padding: 10px; }
        .search-box input { width: 100%; padding: 8px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px; display: flex; gap: 12px; cursor: pointer; border-bottom: 1px solid #f5f5f5; }
        .chat-item:hover { background: #f9f9f9; }
        .chat-item .info { flex: 1; }
        .chat-item h4 { font-size: 15px; }
        .chat-item p { font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Main Chat Area */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; position: relative; }
        .chat-header { padding: 10px 20px; background: #f0f2f5; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #ddd; }
        
        .messages-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Message Bubbles */
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; word-wrap: break-word; }
        .msg.sent { align-self: flex-end; background: #dcf8c6; }
        .msg.received { align-self: flex-start; background: #fff; }
        
        .msg-meta { font-size: 10px; color: #888; display: flex; justify-content: flex-end; gap: 4px; margin-top: 2px; }
        .edited-tag { font-style: italic; font-size: 9px; margin-right: 5px; }
        
        /* Input Area */
        .input-area { padding: 10px 20px; background: #f0f2f5; display: flex; align-items: center; gap: 10px; }
        .input-area input { flex: 1; padding: 10px; border-radius: 25px; border: none; outline: none; }
        .btn-send { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
        .btn-send:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Ticks */
        .tick { font-size: 12px; }
        .tick.seen { color: #34b7f1; }

        /* Profile Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 350px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }

        /* Background Select */
        .bg-options { display: flex; gap: 10px; margin-top: 10px; }
        .bg-thumb { width: 30px; height: 30px; border-radius: 5px; cursor: pointer; border: 2px solid transparent; }
    </style>
</head>
<body>

    <div id="auth-screen" style="display: flex;">
        <div style="background: white; padding: 40px; border-radius: 15px; width: 350px;">
            <h2 id="auth-title">Login to Learnox</h2><br>
            <input type="email" id="auth-email" placeholder="Email" style="width:100%; padding:10px; margin-bottom:10px;">
            <input type="password" id="auth-pass" placeholder="Password" style="width:100%; padding:10px; margin-bottom:20px;">
            <button onclick="handleAuth()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer;">Continue</button>
        </div>
    </div>

    <div class="app-container" id="app-screen" style="display: none;">
        <div class="sidebar">
            <div class="side-header">
                <img src="" id="my-avatar" class="avatar" onclick="toggleModal('profile-modal')">
                <div class="actions">
                    <i class="fas fa-user-plus" onclick="toggleModal('search-modal')"></i>
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            <div class="search-box">
                <input type="text" placeholder="Search chats...">
            </div>
            <div class="chat-list" id="chat-list-container"></div>
        </div>

        <div class="main-chat">
            <div class="chat-header" id="active-chat-header" style="display: none;">
                <img src="" id="active-avatar" class="avatar">
                <div style="flex:1">
                    <h4 id="active-name">User Name</h4>
                    <span id="active-status" style="font-size: 11px; color: #666;">offline</span>
                </div>
                <div class="chat-actions">
                    <i class="fas fa-trash" onclick="deleteFriend()"></i>
                    <i class="fas fa-image" onclick="toggleModal('bg-modal')"></i>
                </div>
            </div>

            <div class="messages-area" id="messages-container">
                </div>

            <div class="input-area" id="chat-input-row" style="display: none;">
                <i class="far fa-smile"></i>
                <input type="text" id="message-input" placeholder="Type a message...">
                <button class="btn-send" id="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <h3>Edit Profile</h3><br>
            <div class="form-group">
                <label>Profile Picture</label>
                <input type="file" id="new-avatar" accept="image/*">
            </div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="new-name">
            </div>
            <div class="form-group">
                <label>Bio</label>
                <input type="text" id="new-bio">
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="new-password">
            </div>
            <button onclick="updateProfile()" class="btn-send" style="width:100%; border-radius:5px;">Save Changes</button>
            <button onclick="toggleModal('profile-modal')" style="width:100%; margin-top:10px; background:none; border:none; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <script>
        const socket = io();
        let currentUser = null;
        let activeChat = null;
        let token = localStorage.getItem('token');
        let isSending = false; // Prevent multiple clicks

        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-pass').value;
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, password})
            });
            const data = await res.json();
            if(data.token) {
                localStorage.setItem('token', data.token);
                location.reload();
            }
        }

        if(token) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            loadApp();
        }

        async function loadApp() {
            // Get My Info
            const res = await fetch('/api/chats', { headers: {'Authorization': `Bearer ${token}`} });
            const chats = await res.json();
            renderChats(chats);
            socket.emit('join', parseJwt(token).userId);
        }

        function renderChats(chats) {
            const container = document.getElementById('chat-list-container');
            container.innerHTML = chats.map(chat => {
                const other = chat.participants.find(p => p.username !== currentUser?.username);
                return `
                    <div class="chat-item" onclick="openChat('${chat._id}', '${other.name}', '${other.avatar}')">
                        <img src="${other.avatar || '/uploads/default.png'}" class="avatar">
                        <div class="info">
                            <h4>${other.name}</h4>
                            <p>${chat.lastMessage?.text || 'No messages'}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function openChat(chatId, name, avatar) {
            activeChat = chatId;
            document.getElementById('active-chat-header').style.display = 'flex';
            document.getElementById('chat-input-row').style.display = 'flex';
            document.getElementById('active-name').innerText = name;
            document.getElementById('active-avatar').src = avatar || '/uploads/default.png';
            
            socket.emit('join_chat', chatId);
            loadMessages(chatId);
        }

        async function loadMessages(chatId) {
            const res = await fetch(`/api/chats/${chatId}/messages`, {
                headers: {'Authorization': `Bearer ${token}`}
            });
            const messages = await res.json();
            const container = document.getElementById('messages-container');
            container.innerHTML = messages.map(msg => renderMessage(msg)).join('');
            container.scrollTop = container.scrollHeight;
        }

        function renderMessage(msg) {
            const isMe = msg.sender === parseJwt(token).userId;
            let ticks = '';
            if(isMe) {
                const tickClass = msg.status === 'seen' ? 'seen' : '';
                const icon = msg.status === 'sent' ? 'fa-check' : 'fa-check-double';
                ticks = `<i class="fas ${icon} tick ${tickClass}"></i>`;
            }

            return `
                <div class="msg ${isMe ? 'sent' : 'received'}" id="msg-${msg._id}">
                    ${msg.text}
                    <div class="msg-meta">
                        ${msg.edited ? '<span class="edited-tag">edited</span>' : ''}
                        ${new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        ${ticks}
                    </div>
                </div>
            `;
        }

        async function sendMessage() {
            if(isSending) return;
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text) return;

            isSending = true;
            document.getElementById('send-btn').disabled = true;

            const res = await fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ chatId: activeChat, text })
            });

            if(res.ok) {
                input.value = '';
                // Message will be added via Socket
            }
            isSending = false;
            document.getElementById('send-btn').disabled = false;
        }

        // Socket Listeners
        socket.on('new_message', (msg) => {
            if(msg.chat === activeChat) {
                const container = document.getElementById('messages-container');
                container.insertAdjacentHTML('beforeend', renderMessage(msg));
                container.scrollTop = container.scrollHeight;
            }
        });

        socket.on('message_deleted', (msgId) => {
            document.getElementById(`msg-${msgId}`)?.remove();
        });

        // Utility: Parse JWT
        function parseJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        async function updateProfile() {
            const formData = new FormData();
            formData.append('name', document.getElementById('new-name').value);
            formData.append('bio', document.getElementById('new-bio').value);
            const pass = document.getElementById('new-password').value;
            if(pass) formData.append('password', pass);
            const file = document.getElementById('new-avatar').files[0];
            if(file) formData.append('avatar', file);

            await fetch('/api/profile', {
                method: 'PUT',
                headers: {'Authorization': `Bearer ${token}`},
                body: formData
            });
            location.reload();
        }
    </script>
</body>
</html>