<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Learnox Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --primary: #008069; --secondary: #00a884; --bg: #eefffc; --white: #ffffff; --green: #25d366; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        body { background: #d1d7db; height: 100vh; display: flex; align-items: center; justify-content: center; }
        
        /* Auth */
        .auth-box { background: var(--white); padding: 40px; border-radius: 10px; width: 100%; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .input-group input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* App Layout */
        .app { display: none; width: 95vw; height: 95vh; background: var(--white); border-radius: 0; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; max-width: 1600px; }
        
        /* Sidebar */
        .sidebar { width: 30%; min-width: 320px; background: #fff; border-right: 1px solid #e9edef; display: flex; flex-direction: column; }
        .header { height: 60px; background: #f0f2f5; display: flex; align-items: center; padding: 0 16px; justify-content: space-between; border-bottom: 1px solid #e9edef; }
        .user-nav { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        
        .search-bar { padding: 8px; background: #fff; border-bottom: 1px solid #e9edef; }
        .search-input { width: 100%; padding: 8px 12px; background: #f0f2f5; border: none; border-radius: 8px; outline: none; }
        
        .list { flex: 1; overflow-y: auto; background: #fff; }
        .list-item { height: 72px; padding: 0 15px; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #f0f2f5; }
        .list-item:hover { background: #f5f6f6; }
        .list-item.active { background: #f0f2f5; }
        
        .avatar { width: 49px; height: 49px; border-radius: 50%; object-fit: cover; }
        .info { flex: 1; border-bottom: 1px solid #f0f2f5; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .top-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .name { font-size: 17px; color: #111b21; font-weight: 400; }
        .time { font-size: 12px; color: #667781; }
        .msg-preview { font-size: 14px; color: #667781; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        /* Chat Area */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #efeae2; position: relative; }
        .chat-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.4; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); z-index: 0; pointer-events: none; }
        .chat-header { height: 60px; background: #f0f2f5; display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid #e9edef; z-index: 2; }
        
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 2px; z-index: 1; }
        
        .msg-row { display: flex; flex-direction: column; margin-bottom: 8px; position: relative; }
        .msg { max-width: 65%; padding: 6px 7px 8px 9px; border-radius: 7.5px; font-size: 14.2px; line-height: 19px; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); cursor: pointer; }
        
        .sent { align-self: flex-end; background: #d9fdd3; border-top-right-radius: 0; }
        .received { align-self: flex-start; background: #fff; border-top-left-radius: 0; }
        
        .msg-meta { float: right; margin-left: 7px; margin-top: 4px; display: flex; align-items: center; gap: 3px; font-size: 11px; color: #667781; height: 15px; }
        .edited-tag { font-size: 11px; color: #667781; font-style: italic; margin-right: 4px; }
        
        .reaction-bubble { position: absolute; bottom: -10px; right: 10px; background: white; padding: 2px 5px; border-radius: 10px; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); z-index: 2; border: 1px solid #ddd; }
        
        .footer { min-height: 62px; background: #f0f2f5; display: flex; align-items: center; padding: 5px 16px; gap: 10px; z-index: 2; }
        .input-box { flex: 1; padding: 9px 12px; background: #fff; border-radius: 8px; border: 1px solid #fff; outline: none; font-size: 15px; }
        
        /* Popup Menu */
        .msg-popup { position: absolute; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 6px; z-index: 1000; width: 180px; display: none; padding: 5px 0; overflow: hidden; animation: popIn 0.1s ease-out; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .popup-item { padding: 10px 15px; font-size: 14px; color: #3b4a54; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .popup-item:hover { background: #f5f6f6; }
        .reaction-row { display: flex; padding: 8px; justify-content: space-around; border-bottom: 1px solid #eee; background: #fdfdfd; }
        .emoji-btn { font-size: 18px; cursor: pointer; transition: transform 0.1s; }
        .emoji-btn:hover { transform: scale(1.2); }

        .hidden { display: none !important; }
        /* Ticks */
        .tick { font-size: 10px; }
        .blue { color: #53bdeb; }
        .grey { color: #8696a0; }

        @media(max-width: 768px) {
            .app { width: 100%; height: 100%; }
            .sidebar { width: 100%; }
            .chat-area { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 20; }
            .chat-area.active { display: flex; }
            .msg { max-width: 80%; }
        }
    </style>
</head>
<body>

    <div id="auth-screen" class="auth-box">
        <h2 style="color:var(--primary); text-align:center; margin-bottom:20px;">Learnox</h2>
        <div class="input-group">
            <input type="text" id="reg-user" class="hidden" placeholder="Username">
            <input type="text" id="reg-name" class="hidden" placeholder="Full Name">
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
        </div>
        <button onclick="auth()" class="btn" id="auth-btn">Login</button>
        <p style="text-align:center; margin-top:15px; font-size:13px; color:#008069; cursor:pointer;" onclick="toggleAuth()">Create Account</p>
    </div>

    <div id="app-screen" class="app hidden">
        <div class="sidebar">
            <div class="header">
                <div class="user-nav">
                    <img id="my-avatar" class="avatar" src="">
                    <span id="my-name" style="font-weight:bold;">Me</span>
                </div>
                <div style="display:flex; gap:15px; color:#54656f;">
                    <i class="fas fa-user-plus" onclick="promptAddFriend()" title="Add Friend"></i>
                    <i class="fas fa-sign-out-alt" onclick="logout()"></i>
                </div>
            </div>
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Search or start new chat" onkeyup="filterChats(this.value)">
            </div>
            <div id="chat-list" class="list"></div>
        </div>

        <div id="chat-interface" class="chat-area">
            <div class="chat-bg"></div>
            <div class="chat-header">
                <i class="fas fa-arrow-left" style="margin-right:15px; cursor:pointer; display:none;" id="back-btn" onclick="closeChat()"></i>
                <img id="chat-avatar" class="avatar" src="">
                <div style="margin-left:15px; flex:1;">
                    <div id="chat-name" style="font-weight:500; font-size:16px;">User</div>
                    <div id="chat-status" style="font-size:12px; color:#667781;">offline</div>
                </div>
            </div>

            <div id="msg-container" class="messages"></div>

            <div class="footer">
                <i class="far fa-smile" style="font-size:24px; color:#8696a0; cursor:pointer; margin-right:10px;"></i>
                <input type="text" id="msg-input" class="input-box" placeholder="Type a message" onkeypress="handleEnter(event)">
                <i class="fas fa-paper-plane" style="font-size:20px; color:#8696a0; cursor:pointer; margin-left:10px;" onclick="sendMsg()"></i>
            </div>
        </div>
        
        <div id="empty-state" class="chat-area" style="background:#f0f2f5; display:flex; align-items:center; justify-content:center; flex-direction:column; border-bottom:6px solid #25d366;">
            <h1 style="color:#41525d; margin-top:20px; font-weight:300;">Learnox Web</h1>
            <p style="color:#667781; margin-top:10px;">Send and receive messages without keeping your phone online.</p>
        </div>
    </div>

    <div id="msg-menu" class="msg-popup">
        <div class="reaction-row">
            <span class="emoji-btn" onclick="reactToMsg('??')">??</span>
            <span class="emoji-btn" onclick="reactToMsg('??')">??</span>
            <span class="emoji-btn" onclick="reactToMsg('??')">??</span>
            <span class="emoji-btn" onclick="reactToMsg('??')">??</span>
            <span class="emoji-btn" onclick="reactToMsg('??')">??</span>
        </div>
        <div class="popup-item" id="opt-edit" onclick="editMsgAction()"><i class="fas fa-pen"></i> Edit</div>
        <div class="popup-item" id="opt-delete" onclick="deleteMsgAction()"><i class="fas fa-trash"></i> Delete</div>
    </div>

    <script>
        const API = '/api';
        let socket, token, me;
        let currentChatId, currentChatUser;
        let isLogin = true;
        let selectedMsg = null;

        // --- AUTH ---
        function toggleAuth() {
            isLogin = !isLogin;
            document.getElementById('auth-btn').innerText = isLogin ? 'Login' : 'Register';
            document.getElementById('reg-user').classList.toggle('hidden');
            document.getElementById('reg-name').classList.toggle('hidden');
        }

        async function auth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('reg-name').value;
            const username = document.getElementById('reg-user').value;
            
            const url = isLogin ? '/login' : '/register';
            const body = isLogin ? { email, password } : { email, password, name, username };

            const res = await fetch(API + url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
            const data = await res.json();
            
            if(data.token) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                location.reload();
            } else alert(data.error);
        }

        function logout() { localStorage.clear(); location.reload(); }

        // --- INIT ---
        window.onload = () => {
            token = localStorage.getItem('token');
            if(token) {
                me = JSON.parse(localStorage.getItem('user'));
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('my-name').innerText = me.name;
                document.getElementById('my-avatar').src = me.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                
                initSocket();
                loadChats();
            }
        };

        function initSocket() {
            socket = io({ auth: { token } });
            
            socket.on('new_message', (msg) => {
                // 1. If chat open, append message
                if(currentChatId === msg.chat) {
                    appendMsg(msg);
                    scrollToBottom();
                    socket.emit('join_chat', currentChatId); // Mark read
                }
                // 2. IMPORTANT: Move chat to TOP of list (Sorting)
                moveChatToTop(msg.chat, msg);
            });

            socket.on('message_updated', (msg) => {
                if(currentChatId === msg.chat) {
                    const txt = document.querySelector(`#msg-${msg._id} .msg-text`);
                    if(txt) {
                        txt.innerText = msg.text;
                        if(!txt.parentNode.querySelector('.edited-tag')) {
                            txt.insertAdjacentHTML('afterend', '<span class="edited-tag">(edited)</span>');
                        }
                    }
                }
            });

            socket.on('message_deleted', ({ _id, chatId }) => {
                if(currentChatId === chatId) {
                    const el = document.getElementById(`msg-${_id}`);
                    if(el) el.remove();
                }
            });

            socket.on('message_reacted', ({ msgId, reactions, chatId }) => {
                if(currentChatId === chatId) {
                    const el = document.getElementById(`msg-${msgId}`);
                    if(el) updateReactionsUI(el, reactions);
                }
            });

            socket.on('user_status', ({ userId, status }) => {
                if(currentChatUser && currentChatUser._id === userId) {
                    document.getElementById('chat-status').innerText = status;
                }
            });
        }

        // --- CHAT LOGIC ---
        async function loadChats() {
            const res = await fetch(API + '/chats', { headers: { 'Authorization': `Bearer ${token}` } });
            const chats = await res.json();
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            chats.forEach(chat => createChatListItem(chat));
        }

        function createChatListItem(chat, prepend = false) {
            const other = chat.participants.find(p => p._id !== me.id);
            if(!other) return;
            
            const div = document.createElement('div');
            div.className = 'list-item';
            div.id = `chat-item-${chat._id}`;
            div.onclick = () => openChat(other, chat._id);
            
            const lastMsg = chat.lastMessage ? chat.lastMessage.text : '';
            const time = chat.lastMessage ? new Date(chat.lastMessage.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
            
            div.innerHTML = `
                <img class="avatar" src="${other.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}">
                <div class="info">
                    <div class="top-row">
                        <span class="name">${other.name}</span>
                        <span class="time">${time}</span>
                    </div>
                    <div class="msg-preview">${lastMsg}</div>
                </div>
            `;
            
            const list = document.getElementById('chat-list');
            if(prepend) list.prepend(div);
            else list.appendChild(div);
        }

        // --- SORTING FUNCTION ---
        async function moveChatToTop(chatId, lastMsgObj) {
            const list = document.getElementById('chat-list');
            const item = document.getElementById(`chat-item-${chatId}`);
            
            if(item) {
                // If item exists, move to top and update text
                list.prepend(item);
                item.querySelector('.msg-preview').innerText = lastMsgObj.text;
                item.querySelector('.time').innerText = new Date(lastMsgObj.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            } else {
                // New chat not in list, fetch and prepend
                // Optimized: just construct manually if we have user data, else reload
                loadChats(); 
            }
        }

        async function openChat(user, chatId) {
            currentChatUser = user;
            currentChatId = chatId;
            
            document.querySelectorAll('.list-item').forEach(i => i.classList.remove('active'));
            const item = document.getElementById(`chat-item-${chatId}`);
            if(item) item.classList.add('active');

            // UI
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');
            document.getElementById('chat-interface').classList.add('active'); // Mobile
            if(window.innerWidth <= 768) document.querySelector('.sidebar').classList.add('hidden');
            document.getElementById('back-btn').style.display = 'block';

            document.getElementById('chat-name').innerText = user.name;
            document.getElementById('chat-avatar').src = user.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
            document.getElementById('chat-status').innerText = user.status;

            socket.emit('join_chat', chatId);
            
            const res = await fetch(API + `/messages/${chatId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const msgs = await res.json();
            const container = document.getElementById('msg-container');
            container.innerHTML = '';
            msgs.forEach(appendMsg);
            scrollToBottom();
        }

        function closeChat() {
            document.getElementById('chat-interface').classList.remove('active'); // Mobile
            document.querySelector('.sidebar').classList.remove('hidden'); // Mobile
            currentChatId = null;
        }

        // --- MESSAGING ---
        async function sendMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !currentChatId) return;

            const tempId = 'temp-' + Date.now();
            const msg = { _id: tempId, text, sender: me.id, createdAt: new Date(), status: 'sent', chat: currentChatId };
            
            appendMsg(msg);
            moveChatToTop(currentChatId, msg); // Move my chat to top too
            scrollToBottom();
            input.value = '';

            const res = await fetch(API + '/messages', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ chatId: currentChatId, text, tempId })
            });
            const data = await res.json();
            
            // Update ID
            const el = document.getElementById(`msg-${tempId}`);
            if(el) {
                el.id = `msg-${data._id}`;
                el.onclick = (e) => showPopup(e, data._id, true);
            }
        }

        function appendMsg(msg) {
            const isMe = msg.sender === me.id || msg.sender._id === me.id;
            const div = document.createElement('div');
            div.className = `msg-row ${isMe ? 'sent' : 'received'}`;
            div.id = `msg-${msg._id}`;
            
            const time = new Date(msg.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const tickHtml = isMe ? `<span class="tick ${msg.status === 'seen' ? 'blue' : 'grey'}"><i class="fas fa-check-double"></i></span>` : '';
            const editedHtml = msg.edited ? `<span class="edited-tag">(edited)</span>` : '';
            
            div.innerHTML = `
                <div class="msg" onclick="showPopup(event, '${msg._id}', ${isMe})">
                    <span class="msg-text">${msg.text}</span>${editedHtml}
                    <div class="msg-meta">
                        ${time} ${tickHtml}
                    </div>
                    <div class="reaction-bubble hidden"></div>
                </div>
            `;
            
            if(msg.reactions && msg.reactions.length > 0) updateReactionsUI(div, msg.reactions);
            document.getElementById('msg-container').appendChild(div);
        }

        function updateReactionsUI(msgEl, reactions) {
            const bubble = msgEl.querySelector('.reaction-bubble');
            if(reactions.length === 0) {
                bubble.classList.add('hidden');
                return;
            }
            // Show last 3 unique emojis
            const emojis = [...new Set(reactions.map(r => r.emoji))].slice(-3).join(' ');
            bubble.innerText = emojis;
            bubble.classList.remove('hidden');
        }

        // --- POPUP MENU ACTIONS ---
        function showPopup(e, msgId, isMe) {
            e.stopPropagation();
            if(msgId.startsWith('temp')) return;
            
            selectedMsg = msgId;
            const menu = document.getElementById('msg-menu');
            
            // Toggle Edit/Delete options based on sender
            document.getElementById('opt-edit').style.display = isMe ? 'block' : 'none';
            document.getElementById('opt-delete').style.display = 'block'; // Can delete for self always
            
            // Positioning
            menu.style.display = 'block';
            const rect = e.currentTarget.getBoundingClientRect();
            menu.style.top = (rect.bottom + 5) + 'px';
            menu.style.left = isMe ? (rect.right - 180) + 'px' : rect.left + 'px';
        }

        async function reactToMsg(emoji) {
            closePopup();
            await fetch(API + `/messages/${selectedMsg}/react`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ emoji })
            });
        }

        async function editMsgAction() {
            closePopup();
            const el = document.querySelector(`#msg-${selectedMsg} .msg-text`);
            const newText = prompt("Edit message:", el.innerText);
            if(newText && newText !== el.innerText) {
                await fetch(API + `/messages/${selectedMsg}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: newText })
                });
            }
        }

        async function deleteMsgAction() {
            closePopup();
            if(confirm("Delete this message?")) {
                await fetch(API + `/messages/${selectedMsg}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            }
        }

        function closePopup() { document.getElementById('msg-menu').style.display = 'none'; }
        window.onclick = (e) => { if(!e.target.closest('.msg')) closePopup(); }

        // --- UTILS ---
        function handleEnter(e) { if(e.key === 'Enter') sendMsg(); }
        function scrollToBottom() { const c = document.getElementById('msg-container'); c.scrollTop = c.scrollHeight; }
        
        async function promptAddFriend() {
            const username = prompt("Enter username to add:");
            if(username) {
                const res = await fetch(API + '/users/search?q=' + username, { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await res.json();
                if(users.length > 0) {
                    await fetch(API + '/chats', { 
                        method:'POST', 
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ targetId: users[0]._id })
                    });
                    loadChats();
                } else alert('User not found');
            }
        }
    </script>
</body>
</html>